<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Astrocast — current forecast</title>
<style>
  :root{
    --bg:#070912; --panel:#0e1021; --ink:#eaf2ff; --muted:#a9b4d4;
    --cyan:#7de2ff; --pink:#ff6bc8; --violet:#7a5cff; --peach:#ff8a5c;
    --glow: 0 0 16px rgba(125,226,255,.45);
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 70% -10%, #0f1630 0%, var(--bg) 55%);color:var(--ink);font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 28px;}
  .brand{display:flex;align-items:baseline;gap:10px;margin:4px 0 16px}
  .brand .tiny{font-weight:700;color:var(--pink);text-shadow:0 0 10px rgba(255,107,200,.35)}
  .brand h1{margin:0;font-weight:900;letter-spacing:.3px;font-size:1.9rem;color:var(--cyan);text-shadow:var(--glow)}
  .brand .subtitle{margin-left:.5rem;color:var(--muted);font-weight:700}
  .pill{margin-left:auto;display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(125,226,255,.10);color:var(--cyan);font-weight:700;border:1px solid rgba(125,226,255,.25)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
  .card{grid-column:span 12;background:
      linear-gradient(180deg,rgba(14,16,33,.95),rgba(7,9,18,.95)),
      radial-gradient(600px 200px at 100% -10%, rgba(122,92,255,.18), transparent 60%),
      radial-gradient(500px 200px at 0% 110%, rgba(255,138,92,.10), transparent 60%);
    border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:14px 14px 16px;
    box-shadow:0 8px 30px rgba(0,0,0,.38)}
  @media(min-width:820px){ .card.sm{grid-column:span 4} .card.md{grid-column:span 6} .card.lg{grid-column:span 12} }
  .card h2{margin:.2rem 0 .5rem 0;color:var(--muted);font-size:1rem;font-weight:800}
  .big{font-size:2.2rem;font-weight:900;letter-spacing:.3px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .list{list-style:none;margin:.25rem 0 0 0;padding:0}
  .list li{padding:8px 0;border-top:1px dashed rgba(255,255,255,.08)}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{padding:8px;border-top:1px dashed rgba(255,255,255,.08);text-align:left}
  .tbl th{color:var(--muted);font-weight:800}
  a{color:var(--cyan)}
  .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.15);border-top-color:var(--pink);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .err{color:#ff9aa2}
  .accent{color:var(--pink)}
  .foot{margin-top:10px;color:var(--muted);font-size:.95rem}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .small{font-size:.9rem}
</style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <span class="tiny">The</span>
      <h1>Astrocast</h1>
      <span class="subtitle">— current forecast</span>
      <span class="pill" id="loc-pill"><span class="spinner"></span> Getting location…</span>
    </div>

    <div class="grid">
      <div class="card sm">
        <h2>Cloud Cover</h2>
        <div class="big" id="cloudCover">—</div>
        <div class="muted" id="cloudNote">Current total cloud (%)</div>
      </div>

      <div class="card sm">
        <h2>Moon Phase</h2>
        <div class="big" id="moonPhase">—</div>
        <div class="muted" id="moonIllum">—</div>
      </div>

      <div class="card sm">
        <h2>Conditions</h2>
        <div class="row">
          <div><strong id="tempNow">—</strong> <span class="muted">°F</span></div>
          <div><strong id="precipNow">—</strong> <span class="muted">mm/h</span></div>
        </div>
        <div class="muted">Temperature & precip (current)</div>
      </div>

      <div class="card md">
        <h2>Next ISS Pass</h2>
        <div id="issInfo">Calculating… <span class="spinner"></span></div>
        <div class="muted small">Computed locally from latest TLEs.</div>
      </div>

      <div class="card md">
        <h2>Upcoming Astronomy Events</h2>
        <ul class="list" id="eventsList"><li>Loading…</li></ul>
        <div class="muted small">Auto-filtered to the next few weeks.</div>
      </div>

      <div class="card lg">
        <h2>3 Targets for Tonight</h2>
        <table class="tbl small" id="targetsTbl">
          <thead>
            <tr><th>Target</th><th>RA</th><th>Dec</th><th>Rise</th><th>Set</th></tr>
          </thead>
          <tbody><tr><td colspan="5">Picking for your latitude/date…</td></tr></tbody>
        </table>
        <div class="muted small">RA/Dec (J2000). Rise/Set are approximate, computed locally.</div>
      </div>

      <div class="card lg" id="sevenDayCard">
        <h2>7-Day Outlook</h2>
        <table class="tbl small" id="sevenDay">
          <thead><tr><th>Day</th><th>Cloud</th><th>Hi / Lo</th><th>Moon</th></tr></thead>
          <tbody><tr><td colspan="4">Loading 7-day forecast…</td></tr></tbody>
        </table>
      </div>

      <div class="card lg">
        <h2>Space Tidbits</h2>
        <div id="factQuote">
          <div class="small" id="randFact">Loading fact…</div>
          <div class="small" style="margin-top:8px"><em id="randQuote">Loading quote…</em></div>
        </div>
      </div>
    </div>

    <div class="foot">Data: Open-Meteo (no key). ISS via CelesTrak + satellite.js. All times local.</div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/1.3.0/satellite.min.js" defer></script>
<script>
(async function(){
  const $ = id => document.getElementById(id);
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const toF = c => Math.round((c * 9/5) + 32);
  const fmtTime = d => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  const fmtHM = n => String(Math.round(n*10)/10);
  const dayName = d => d.toLocaleDateString([], {weekday:'short', month:'numeric', day:'numeric'});

  // Geolocation (fallback: Charlotte, NC)
  const getPos = () => new Promise(resolve=>{
    if(!navigator.geolocation) return resolve({coords:{latitude:35.2271, longitude:-80.8431}});
    navigator.geolocation.getCurrentPosition(
      p=>resolve(p),
      _=>resolve({coords:{latitude:35.2271, longitude:-80.8431}}),
      {enableHighAccuracy:true, timeout:7000, maximumAge:0}
    );
  });
  const pos = await getPos();
  const lat = +pos.coords.latitude.toFixed(4);
  const lon = +pos.coords.longitude.toFixed(4);
  $("loc-pill").innerHTML = `📍 ${lat}, ${lon}`;

  // Weather: current + 7-day (hourly for clouds to compute daily mean)
  let hourlyCloud = null, hourlyTimes = null, dailyMax = null, dailyMin = null, dailyDates = null;
  try{
    const url = new URL("https://api.open-meteo.com/v1/forecast");
    url.search = new URLSearchParams({
      latitude: lat, longitude: lon,
      current: "temperature_2m,precipitation,cloud_cover",
      hourly: "cloud_cover,precipitation",
      daily: "temperature_2m_max,temperature_2m_min",
      forecast_days: 7, timezone: "auto"
    }).toString();

    const wx = await fetch(url).then(r=>r.json());
    // Current
    const cur = wx.current || {};
    const cloud = Math.round(cur.cloud_cover ?? wx.hourly?.cloud_cover?.[0] ?? 0);
    $("cloudCover").textContent = `${clamp(cloud,0,100)}%`;
    const tempF = toF(cur.temperature_2m ?? NaN);
    const prec = (cur.precipitation ?? NaN);
    $("tempNow").textContent = isFinite(tempF) ? tempF : "—";
    $("precipNow").textContent = isFinite(prec) ? prec.toFixed(2) : "—";

    // Save series for 7-day
    hourlyCloud = wx.hourly?.cloud_cover || [];
    hourlyTimes = (wx.hourly?.time || []).map(t => new Date(t));
    dailyMax = wx.daily?.temperature_2m_max || [];
    dailyMin = wx.daily?.temperature_2m_min || [];
    dailyDates = (wx.daily?.time || []).map(t => new Date(t));
  }catch(e){
    $("cloudNote").innerHTML = `<span class="err">Weather fetch failed</span>`;
  }

  // Moon phase (local calc)
  function moonPhaseInfo(date=new Date()){
    const synodic = 29.530588853;
    const knownNew = new Date(Date.UTC(2000,0,6,18,14));
    const days = (date - knownNew)/86400000;
    const phase = (days % synodic + synodic) % synodic;
    const illum = (1 - Math.cos(2*Math.PI*phase/synodic)) / 2;
    let label="";
    const p=phase;
    if (p < 1.84566) label = "New Moon";
    else if (p < 5.53699) label = "Waxing Crescent";
    else if (p < 9.22831) label = "First Quarter";
    else if (p < 12.91963) label = "Waxing Gibbous";
    else if (p < 16.61096) label = "Full Moon";
    else if (p < 20.30228) label = "Waning Gibbous";
    else if (p < 23.99361) label = "Last Quarter";
    else if (p < 27.68493) label = "Waning Crescent";
    else label = "New Moon";
    return {label, illum: Math.round(illum*100)};
  }
  const mp = moonPhaseInfo();
  $("moonPhase").textContent = mp.label;
  $("moonIllum").textContent = `${mp.illum}% illuminated`;

  // 7-day table: compute mean cloud per day from hourly
  if (hourlyCloud && hourlyTimes && dailyDates && dailyMax && dailyMin) {
    const tbody = document.querySelector("#sevenDay tbody");
    tbody.innerHTML = "";
    for (let i=0;i<dailyDates.length;i++){
      const d0 = new Date(dailyDates[i]); d0.setHours(0,0,0,0);
      const d1 = new Date(d0); d1.setDate(d0.getDate()+1);
      let sum=0, n=0;
      for(let j=0;j<hourlyTimes.length;j++){
        const t = hourlyTimes[j];
        if (t>=d0 && t<d1) { sum += (hourlyCloud[j] ?? 0); n++; }
      }
      const meanCloud = n? Math.round(sum/n): NaN;
      const moon = moonPhaseInfo(d0);
      const hi = dailyMax[i] != null ? toF(dailyMax[i]) : "—";
      const lo = dailyMin[i] != null ? toF(dailyMin[i]) : "—";
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${dayName(d0)}</td>
                      <td>${isFinite(meanCloud)? meanCloud+"%":"—"}</td>
                      <td>${hi}° / ${lo}°</td>
                      <td>${moon.label}</td>`;
      tbody.appendChild(tr);
    }
  }

  // Next ISS pass (satellite.js + CelesTrak TLE)
  async function nextISSPass(lat, lon){
    const tle = await fetch("https://celestrak.org/NORAD/elements/gp.php?CATNR=25544&FORMAT=TLE").then(r=>r.text());
    const lines = tle.trim().split(/\r?\n/).slice(-2);
    const satrec = satellite.twoline2satrec(lines[0], lines[1]);

    const obs = {
      latitude: satellite.degreesToRadians(lat),
      longitude: satellite.degreesToRadians(lon),
      height: 0.2
    };
    const start = new Date();
    const end = new Date(start.getTime() + 24*60*60*1000);
    const step = 30*1000;

    function altAt(t){
      const gmst = satellite.gstime(t);
      const pv = satellite.propagate(satrec, t);
      if(!pv.position) return null;
      const ecf = satellite.eciToEcf(pv.position, gmst);
      const aa = satellite.ecfToLookAngles(obs, ecf);
      return { el: aa.elevation, when: new Date(t) };
    }

    let found=null;
    for(let t=+start; t<=+end; t+=step){
      const a = altAt(new Date(t));
      if(!a) continue;
      if(satellite.radiansToDegrees(a.el) > 20){
        // refine peak
        let peak=a, tt=t;
        for(let j=0;j<40;j++){
          tt += 15*1000;
          const b = altAt(new Date(tt));
          if(!b) break;
          if(b.el > peak.el) peak=b;
        }
        found = {
          start:new Date(t),
          peak:peak.when,
          peakEl: Math.round(satellite.radiansToDegrees(peak.el))
        };
        break;
      }
    }
    return found;
  }

  try{
    const pass = await nextISSPass(lat,lon);
    $("issInfo").innerHTML = pass
      ? `Starts ~ <strong class="accent">${fmtTime(pass.start)}</strong>, peak <strong class="accent">${fmtTime(pass.peak)}</strong> at <strong class="accent">${pass.peakEl}°</strong>`
      : `No upcoming passes in the near future.`;
  }catch(e){
    $("issInfo").innerHTML = `No upcoming passes in the near future.`;
  }

  // --- Targets with RA/Dec and rise/set ---
  // Simple catalog (J2000) for the picks in Jul–Oct used earlier
  const catalog = {
    "Lagoon Nebula (M8)":     { ra: 270.925, dec: -24.38 },
    "Trifid Nebula (M20)":    { ra: 271.15,  dec: -23.02 },
    "Eagle Nebula (M16)":     { ra: 274.700, dec: -13.81 },
    "Andromeda Galaxy (M31)": { ra: 10.6847, dec: 41.269 },
    "North America Nebula (NGC 7000)": { ra: 314.0, dec: 44.5 },
    "Veil Nebula (NGC 6960/6992)": { ra: 312.0, dec: 31.0 },
    "Triangulum Galaxy (M33)":{ ra: 23.462,  dec: 30.660 },
    "Pacman Nebula (NGC 281)":{ ra: 13.0*15+25/60*15, dec: 56.6 }, // ~ RA 1h25m
    "Heart & Soul Nebulae":   { ra: 38.0,   dec: 61.0 },
    "Pleiades (M45)":         { ra: 56.75,  dec: 24.12 }
  };

  const month = new Date().getMonth()+1;
  const picksByMonth = {
    7:["Lagoon Nebula (M8)","Trifid Nebula (M20)","Eagle Nebula (M16)"],
    8:["Andromeda Galaxy (M31)","North America Nebula (NGC 7000)","Veil Nebula (NGC 6960/6992)"],
    9:["Andromeda Galaxy (M31)","Triangulum Galaxy (M33)","Pacman Nebula (NGC 281)"],
    10:["Pacman Nebula (NGC 281)","Heart & Soul Nebulae","Pleiades (M45)"]
  };
  const fallback = ["Milky Way Scutum Star Cloud","Small Sagittarius Star Cloud (M24)","Sadr Region (IC 1318)"];
  const picks = picksByMonth[month] || fallback;

  // Sidereal helpers for rise/set
  function jd(date){ return date.getTime()/86400000 + 2440587.5; }
  function gmst(date){
    const D = jd(date) - 2451545.0;
    let gmstHours = 18.697374558 + 24.
